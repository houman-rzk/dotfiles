#!/bin/sh

rawQuery="/tmp/rawQuery"
queryChannels="/tmp/queryChannels"
querySubs="/tmp/querySub"
queryVideos="/tmp/queryVideos"
queryMerge="/tmp/queryMerge"
queryUrls="/tmp/queryUrls"

instance="$1"
instance="https://yewtu.be"
convertedInstance="$(echo "$instance" | sed 's/\//\\\//g')"

search="$(dmenu -p "Search channel:" < /dev/null | sed 's/ /+/g')"
# Store downloaded channel names and search there, if not there then do the regular search

query="${instance}/search?q=${search}&type=channel&sort=relevance"

curl "$query" 2>/dev/null 1> "$rawQuery"

grep 'dir="auto"' "$rawQuery" | grep -o --color=never '>.*<' | sed -e 's/^>//g' -e 's/&nbsp;<i class.*//g' -e 's/<$//g' > "$queryChannels"

grep -o --color=never '[0-9][0-9,]* subscribers' "$rawQuery" > "$querySubs"

grep -o --color=never '[0-9][0-9,]* videos' "$rawQuery" > "$queryVideos"

grep href "$rawQuery" | grep -o --color=never '/channel/.*"' | sed -e 's/"$//g' -e "s/^/$convertedInstance/g" > "$queryUrls"

paste --delimiters=" " "$queryChannels" "$querySubs" "$queryVideos" > "$queryMerge"

selection="$(dmenu -i -l 15 -p "Select channel:" < "$queryMerge" | sed 's/ [0-9].*$//g')"

line="$(grep -n "$selection" "$queryChannels" | cut -d ':' -f 1 | head -n 1)"

channelUrl="$(sed "${line}q;d" "$queryUrls")"

videos "$channelUrl"
