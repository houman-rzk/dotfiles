#!/bin/sh

WALLPAPER_LINK="$XDG_DATA_HOME/bg"
WALLPAPERS_FILE="$XDG_DATA_HOME/wallpapers-file"

pywal_setbg() {
    xwallpaper --zoom "$WALLPAPER_LINK"

    # COURTESY OF LUKE SMITH'S VOIDRICE
    # If pywal is installed, use it.
    if command -v wal >/dev/null 2>&1 ; then
        touch /tmp
        wal -ni "$(readlink -f "$WALLPAPER_LINK")" -o "$XDG_CONFIG_HOME/wal/postrun" > /dev/null 2>&1
    # If pywal is not installed, return config files to normal.
    else
        dunstconf="$XDG_CONFIG_HOME/dunst/dunstrc"
        zathuraconf="$XDG_CONFIG_HOME/zathura/zathurarc"

    	[ -f "$dunstconf.bak" ] && unlink "$dunstconf" && mv "$dunstconf.bak" "$dunstconf"
    	[ -f "$zathuraconf.bak" ] && unlink "$zathuraconf" && mv "$zathuraconf.bak" "$zathuraconf"
    fi

    killall -HUP dwm >/dev/null 2>&1
}

create_wallpapers_file(){
    find "$WALLPAPERS_DIR" -not -path "$WALLPAPERS_DIR/Deleted/*" -type f -size +6k | shuf > "$WALLPAPERS_FILE"
}


if [ "$#" -eq 1 ] && [ "$1" = "-r" ] ; then
    pywal_setbg
    exit
fi

[ -L "$WALLPAPER_LINK" ] && rm "$WALLPAPER_LINK"

if [ "$#" -eq 1 ] ; then
    ln -s "$1" "$WALLPAPER_LINK"
else
    { [ ! -f "$WALLPAPERS_FILE" ] || [ "$(wc -l "$WALLPAPERS_FILE" 2>/dev/null | awk '{print $1}')" -eq 0 ] ;} && create_wallpapers_file

    ln -s "$(sed '1q' "$WALLPAPERS_FILE")" "$WALLPAPER_LINK"

    sed '1d' "$WALLPAPERS_FILE" > "$WALLPAPERS_FILE".tmp && mv "$WALLPAPERS_FILE".tmp "$WALLPAPERS_FILE"
fi

pywal_setbg
