#!/bin/sh

WALLPAPER_LINK="$XDG_DATA_HOME/bg"

[ -L "$WALLPAPER_LINK" ] && rm "$WALLPAPER_LINK"

if [ "$#" -eq 1 ] ; then
    ln -s "$1" "$WALLPAPER_LINK"
else
    { [ ! -f "$XDG_DATA_HOME/wallpapers-file" ] || [ "$(wc -l "$XDG_DATA_HOME/wallpapers-file" 2>/dev/null | awk '{print $1}')" -eq 0 ] ;} && shuf -e "$WALLPAPERS_DIR/Sorted"/* > "$XDG_DATA_HOME"/wallpapers-file

    ln -s "$(head -n 1 "$XDG_DATA_HOME/wallpapers-file")" "$WALLPAPER_LINK"

    tail -n +2 "$XDG_DATA_HOME/wallpapers-file" > /tmp/wallpapers-file.tmp && mv /tmp/wallpapers-file.tmp "$XDG_DATA_HOME/wallpapers-file"
fi

xwallpaper --zoom "$WALLPAPER_LINK"
#feh --no-fehbg --bg-fill "$WALLPAPER_LINK"

setsid -f wal -nqi "$(readlink -f "$XDG_DATA_HOME/bg")"
setsid -f xrdb -merge "$XDG_CONFIG_HOME"/x11/Xresources
setsid -f killall -HUP dwm
