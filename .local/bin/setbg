#!/bin/sh

WALLPAPER_LINK="$XDG_DATA_HOME/bg"

pywal_setbg() {
    xwallpaper --zoom "$WALLPAPER_LINK"

    # COURTESY OF LUKE SMITH'S VOIDRICE
    # If pywal is installed, use it.
    if command -v wal >/dev/null 2>&1 ; then
        wal -ni "$(readlink -f "$WALLPAPER_LINK")" -o "$XDG_CONFIG_HOME/wal/postrun" > /dev/null 2>&1
    # If pywal is not installed, return config files to normal.
    else
        dunstconf="$XDG_CONFIG_HOME/dunst/dunstrc"
        zathuraconf="$XDG_CONFIG_HOME/zathura/zathurarc"

    	[ -f "$dunstconf.bak" ] && unlink "$dunstconf" && mv "$dunstconf.bak" "$dunstconf"
    	[ -f "$zathuraconf.bak" ] && unlink "$zathuraconf" && mv "$zathuraconf.bak" "$zathuraconf"
    fi

    killall -HUP dwm >/dev/null 2>&1
}

if [ "$#" -eq 1 ] && [ "$1" = "-r" ] ; then
    pywal_setbg
    exit
fi

[ -L "$WALLPAPER_LINK" ] && rm "$WALLPAPER_LINK"

if [ "$#" -eq 1 ] ; then
    ln -s "$1" "$WALLPAPER_LINK"
else
    { [ ! -f "$XDG_DATA_HOME/wallpapers-file" ] || [ "$(wc -l "$XDG_DATA_HOME/wallpapers-file" 2>/dev/null | awk '{print $1}')" -eq 0 ] ;} && shuf -e "$WALLPAPERS_DIR/Sorted"/* > "$XDG_DATA_HOME"/wallpapers-file

    ln -s "$(head -n 1 "$XDG_DATA_HOME/wallpapers-file")" "$WALLPAPER_LINK"

    tail -n +2 "$XDG_DATA_HOME/wallpapers-file" > /tmp/wallpapers-file.tmp && mv /tmp/wallpapers-file.tmp "$XDG_DATA_HOME/wallpapers-file"
fi

pywal_setbg
