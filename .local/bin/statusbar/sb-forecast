#!/bin/sh

weatherreport="$XDG_CACHE_HOME/weatherreport"

getforecast() { curl -sf "wttr.in" > "$weatherreport" || exit 1 ;}

temp="$(sed '4q;d' "$weatherreport" | grep -o "[+-][0-9]*" | tail -n 1 | sed s/+//g)"

[ "$temp" = "-" ] && temp="$(sed '4q;d' "$weatherreport" | awk '{print $4}' | sed s/+//g | sed "s,\x1B\[[0-9;]*[a-zA-Z],,g")"

showweather () { echo "Ô™ß $temp¬∞" ;}

[ "$(stat -c %y "$weatherreport" | cut -d ':' -f 1)" = "$(date '+%F %H')" ] || \
	getforecast

# get max/min/precip
extractforecast() { 
	precip="$(sed '16q;d' "$weatherreport" | grep -o "[0-9]*%" | sort -rn | sed -e '1q')" ;
	mintemp="$(sed '13q;d' "$weatherreport" | grep -o "m\\([-+]\\)*[0-9]\\+" | sed 's/+//g' | sort -n -t 'm' -k 2n | sed -e 's/m//g;1q')" ;
	maxtemp="$(sed '13q;d' "$weatherreport" | grep -o "m\\([-+]\\)*[0-9]\\+" | sed 's/+//g' | sort -n -t 'm' -k 2n | sed -e 's/m//g;$!d')" ;}

case $BLOCK_BUTTON in
	1) setsid -f "$TERMINAL" -f "monospace:size=10" -e less -Srf "$weatherreport" ;;
	2) echo "$temp" ;; 
	3) extractforecast && dunstify -u low -r 1 -t 3000 "Weather module" "\- Left click for full forecast.
- Middle click to update forecast.
üü°$maxtemp ‚ùÑÔ∏è$mintemp üíß$precip" ;;
esac

showweather
